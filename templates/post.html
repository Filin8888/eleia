<!-- –î–µ—Ç–∞–ª—ñ –ø–æ—Å—Ç–∞ + –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
<article class="post-card">
  <h2>{{ post.title }}</h2>
  <p class="meta">–ê–≤—Ç–æ—Ä: {{ post.author.username }} ¬∑ {{ post.created_at.strftime('%Y-%m-%d %H:%M') }}</p>

{% set main_image = post.images|selectattr('is_main')|list %}
{% if main_image %}
  <div class="main-image">
    <img src="{{ url_for('static', filename='uploads/' ~ main_image[0].filename) }}">
  </div>
{% endif %}


  <div class="gallery">
  {% for img in post.images %}
    <img class="thumb" src="{{ url_for('static', filename='uploads/' ~ img.filename) }}">
  {% endfor %}
  </div>

  <div class="body">{{ post.content }}</div>

  <div class="post-actions">
    {% if current_user.is_authenticated %}
      <form method="post" action="{{ url_for('main.like_post', post_id=post.id) }}">
        <button type="submit" class="btn-ghoust">üëç {{ post.likes|length }}</button>
      </form>
      {% if current_user.role in ['admin','moderator'] or current_user.id == post.user_id %}
        <a href="{{ url_for('main.edit_post', post_id=post.id) }}" class="btn">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
        <form method="post" action="{{ url_for('main.delete_post', post_id=post.id) }}" style="display:inline;">
          <button class="btn-danger" type="submit">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </form>
      {% endif %}
    {% endif %}
  </div>
</article>

<div class="comments-section">
    <h3>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h3>

    {% for comment in post.comments %}
    <div class="comment">
        <div class="comment-header">
            <span class="comment-author">{{ comment.user.username }}</span>
            <span class="comment-date">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>
        <div class="comment-body">
            {{ comment.content }}
        </div>
    </div>
    {% else %}
    <p>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ —â–µ –Ω–µ–º–∞—î. –ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º!</p>
    {% endfor %}

    {% if current_user.is_authenticated %}
    <form method="POST" action="{{ url_for('main.add_comment', post_id=post.id) }}" class="comment-form">
        {{ comment_form.hidden_tag() }}
        {{ comment_form.content(class="form-textarea", placeholder="–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤—ñ–π –∫–æ–º–µ–Ω—Ç–∞—Ä...") }}
        {{ comment_form.submit(class="btn btn-submit") }}
    </form>
    {% else %}
    <p>–©–æ–± –∑–∞–ª–∏—à–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä, <a href="{{ url_for('main.login') }}">—É–≤—ñ–π–¥—ñ—Ç—å</a>.</p>
    {% endif %}

</div>

{% endblock %}

<script>
const imagesInput = document.getElementById('images');
const preview = document.getElementById('preview');
const mainIndexInput = document.getElementById('main_image_index');

imagesInput.addEventListener('change', () => {
    preview.innerHTML = '';
    const files = imagesInput.files;
    Array.from(files).forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('preview-img');
            img.style.cursor = 'pointer';
            if (i == 0) img.style.border = '3px solid red'; // –ø–µ—Ä—à–µ –≥–æ–ª–æ–≤–Ω–µ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
            img.addEventListener('click', () => {
                mainIndexInput.value = i;
                document.querySelectorAll('.preview-img').forEach(el => el.style.border = '');
                img.style.border = '3px solid red';
            });
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
    mainIndexInput.value = 0;
});

</script>

<style>


</style>




