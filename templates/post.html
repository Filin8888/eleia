<!-- Деталі поста + коментарі -->
{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}
{% block content %}
<main>
  <h1>{{ post.title }}</h1>
  <div class="main-image">
    {% if post.main_image %}
      <img src="{{ url_for('static', filename='uploads/' + post.main_image) }}">
    {% endif %}
  </div>

  <p>{{ post.content }}</p>

 {% if post.gallery_images %}
  <div class="gallery d-flex flex-wrap gap-2">
    {% for img in post.gallery_images %}
    <img src="{{ url_for('static', filename='uploads/' + img.filename) }}"
         class="gallery-img"
         alt="Фото {{ loop.index }}">
    {% endfor %}
  </div>
  {% endif %}
</div>

<!-- === Модальне вікно для перегляду === -->
<div id="lightbox" class="lightbox">
  <span class="close">&times;</span>
  <img class="lightbox-image" src="" alt="">
  <a class="prev">&#10094;</a>
  <a class="next">&#10095;</a>
</div>

  {% if current_user.role in ['admin','moderator'] or current_user.id == post.user_id %}
        <a href="{{ url_for('main.edit_post', post_id=post.id) }}" class="btn">Редагувати</a>
        <form method="post" action="{{ url_for('main.delete_post', post_id=post.id) }}" style="display:inline;">
          <button class="btn-danger" type="submit">Видалити</button>
        </form>
  {% endif %}
</main>

<div class="comments-section">
    <h3>Коментарі</h3>

    {% for comment in post.comments %}
    <div class="comment">
        <div class="comment-header">
            <span class="comment-author">{{ comment.user.username }}</span>
            <span class="comment-date">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>
        <div class="comment-body">
            {{ comment.content }}
        </div>
    </div>
    {% else %}
    <p>Коментарів ще немає. Будьте першим!</p>
    {% endfor %}

    {% if current_user.is_authenticated %}
    <form method="POST" action="{{ url_for('main.add_comment', post_id=post.id) }}" class="comment-form">
        {{ comment_form.hidden_tag() }}
        {{ comment_form.content(class="form-textarea", placeholder="Напишіть свій коментар...") }}
        {{ comment_form.submit(class="btn btn-submit") }}
    </form>
    {% else %}
    <p>Щоб залишити коментар, <a href="{{ url_for('main.login') }}">увійдіть</a>.</p>
    {% endif %}

</div>

<style>
/* ===================== */
/* ОКРЕМИЙ ПОСТ */
/* ===================== */

/* --- головне зображення --- */
.main-image img {
  width: 100%;
  max-height: 400px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 10px;
}

/* --- галерея зображень --- */
.gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.gallery .thumb {
  width: 150px;
  height: 100px;
  object-fit: cover;
  border-radius: 5px;
  cursor: pointer;
  transition: transform 0.2s;
}

.gallery .thumb:hover {
  transform: scale(1.05);
}

/* --- секція коментарів --- */
.comments-section {
  max-width: 700px;
  margin: 30px auto;
  padding: 20px;
  background-color: #f5f5dc;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.comments-section h3 {
  margin-bottom: 15px;
  font-size: 1.5em;
  color: #556b2f;
}

.comment {
  padding: 10px 15px;
  margin-bottom: 15px;
  background-color: #e6e6b8;
  border-radius: 6px;
  border-left: 4px solid #808000;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 0.9em;
  color: #333;
}

.comment-author {
  font-weight: 600;
  color: #556b2f;
}

.comment-body {
  font-size: 1em;
  line-height: 1.5;
  color: #222;
}

.comment-form {
  margin-top: 20px;
}

.comment-form .form-textarea {
  width: 100%;
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid #ccc;
  min-height: 80px;
  margin-bottom: 10px;
}

.comment-form .btn-submit {
  background-color: #808000;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  font-weight: 600;
  cursor: pointer;
}

.comment-form .btn-submit:hover {
  background-color: #6b6b00;
}


</style>


<style>
.gallery {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.gallery-img {
  width: 150px;
  height: 100px;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.gallery-img:hover {
  transform: scale(1.05);
}

/* Лайтбокс */
.lightbox {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

.lightbox-image {
  max-width: 90%;
  max-height: 80%;
  border-radius: 10px;
}

.close {
  position: absolute;
  top: 20px;
  right: 35px;
  color: white;
  font-size: 40px;
  cursor: pointer;
}

.prev, .next {
  cursor: pointer;
  position: absolute;
  top: 50%;
  width: auto;
  padding: 16px;
  color: white;
  font-weight: bold;
  font-size: 40px;
  user-select: none;
  transition: 0.3s;
}

.prev:hover, .next:hover {
  color: #ddd;
}

.prev { left: 30px; }
.next { right: 30px; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const images = document.querySelectorAll('.gallery-img');
  const lightbox = document.getElementById('lightbox');
  const lightboxImage = document.querySelector('.lightbox-image');
  const closeBtn = document.querySelector('.close');
  const prevBtn = document.querySelector('.prev');
  const nextBtn = document.querySelector('.next');
  
  let currentIndex = 0;

  images.forEach((img, index) => {
    img.addEventListener('click', () => {
      lightbox.style.display = 'flex';
      lightboxImage.src = img.src;
      currentIndex = index;
    });
  });

  const showImage = (index) => {
    if (index < 0) index = images.length - 1;
    if (index >= images.length) index = 0;
    lightboxImage.src = images[index].src;
    currentIndex = index;
  };

  prevBtn.addEventListener('click', () => showImage(currentIndex - 1));
  nextBtn.addEventListener('click', () => showImage(currentIndex + 1));
  
  closeBtn.addEventListener('click', () => lightbox.style.display = 'none');
  lightbox.addEventListener('click', (e) => {
    if (e.target === lightbox) lightbox.style.display = 'none';
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') lightbox.style.display = 'none';
    if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
    if (e.key === 'ArrowRight') showImage(currentIndex + 1);
  });
});
</script>

{% endblock %}


<script>
const imagesInput = document.getElementById('images');
const preview = document.getElementById('preview');
const mainIndexInput = document.getElementById('main_image_index');

imagesInput.addEventListener('change', () => {
    preview.innerHTML = '';
    const files = imagesInput.files;
    Array.from(files).forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('preview-img');
            img.style.cursor = 'pointer';
            if (i == 0) img.style.border = '3px solid red'; // перше головне за замовчуванням
            img.addEventListener('click', () => {
                mainIndexInput.value = i;
                document.querySelectorAll('.preview-img').forEach(el => el.style.border = '');
                img.style.border = '3px solid red';
            });
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
    mainIndexInput.value = 0;
});

</script>
