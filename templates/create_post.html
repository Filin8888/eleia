{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Створити пост</h2>

  <form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <div class="mb-3">
      {{ form.title.label(class="form-label") }}
      {{ form.title(class="form-control") }}
    </div>

    <div class="mb-3">
      {{ form.content.label(class="form-label") }}
      {{ form.content(class="form-control") }}
    </div>

    <!-- Головне зображення -->
    <div class="mb-3", style="display: none;">
      {{ form.main_image.label(class="form-label") }}
      {{ form.main_image(class="form-control", id="mainImageInput") }}
      <div id="mainImagePreview" class="mt-2"></div>
    </div>

    <!-- Галерея з кнопкою "+" -->
    <div class="mb-3">
      <label class="form-label">Галерея</label>
      <div id="galleryPreview" class="d-flex flex-wrap"></div>

      <button type="button" id="addGalleryImage" class="btn btn-outline-primary mt-2">+</button>
      <input type="file" id="galleryInput" name="gallery_images[]" multiple hidden>
    </div>

    <button type="submit" class="btn btn-success mt-3">Опублікувати</button>
  </form>
</div>

<script>
  // Попередній перегляд головного зображення
  document.getElementById('mainImageInput').addEventListener('change', function (event) {
    const preview = document.getElementById('mainImagePreview');
    preview.innerHTML = '';
    const file = event.target.files[0];
    if (file) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.style.width = '200px';
      img.style.borderRadius = '8px';
      preview.appendChild(img);
    }
  });

  // Галерея з кнопкою "+"
  const addBtn = document.getElementById('addGalleryImage');
  const input = document.getElementById('galleryInput');
  const preview = document.getElementById('galleryPreview');
  let files = [];

  addBtn.addEventListener('click', () => input.click());

  input.addEventListener('change', (e) => {
    const newFiles = Array.from(e.target.files);
    files = files.concat(newFiles);

    preview.innerHTML = '';

    files.forEach((file, index) => {
      const div = document.createElement('div');
      div.style.position = 'relative';
      div.style.margin = '5px';

      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.style.width = '120px';
      img.style.height = 'auto';
      img.style.borderRadius = '6px';

      const removeBtn = document.createElement('button');
      removeBtn.innerText = '×';
      removeBtn.style.position = 'absolute';
      removeBtn.style.top = '0';
      removeBtn.style.right = '0';
      removeBtn.style.background = 'red';
      removeBtn.style.color = 'white';
      removeBtn.style.border = 'none';
      removeBtn.style.borderRadius = '50%';
      removeBtn.style.cursor = 'pointer';
      removeBtn.onclick = () => {
        files.splice(index, 1);
        updateGalleryPreview();
      };

      div.appendChild(img);
      div.appendChild(removeBtn);
      preview.appendChild(div);
    });

    updateGalleryPreview();
  });

  // Оновлення галереї після видалення
  function updateGalleryPreview() {
    const dataTransfer = new DataTransfer();
    files.forEach(f => dataTransfer.items.add(f));
    input.files = dataTransfer.files;

    preview.innerHTML = '';
    files.forEach((file, index) => {
      const div = document.createElement('div');
      div.style.position = 'relative';
      div.style.margin = '5px';

      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.style.width = '120px';
      img.style.borderRadius = '6px';

      const removeBtn = document.createElement('button');
      removeBtn.innerText = '×';
      removeBtn.style.position = 'absolute';
      removeBtn.style.top = '0';
      removeBtn.style.right = '0';
      removeBtn.style.background = 'red';
      removeBtn.style.color = 'white';
      removeBtn.style.border = 'none';
      removeBtn.style.borderRadius = '50%';
      removeBtn.onclick = () => {
        files.splice(index, 1);
        updateGalleryPreview();
      };

      div.appendChild(img);
      div.appendChild(removeBtn);
      preview.appendChild(div);
    });
  }
</script>

<style>
#preview {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    max-height: 200px; /* обмежуємо висоту прев’ю */
    overflow-y: auto;  /* якщо картинки виходять за висоту, буде скрол */
}

.preview-img {
    width: 100px;
    height: 100px;
    object-fit: cover; /* обрізає, щоб не тягнуло пропорції */
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 5px;
    transition: border 0.2s;
}

.preview-img.main {
    border: 3px solid red;
}
</style>
{% endblock %}